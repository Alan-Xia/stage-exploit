<!DOCTYPE html>
<html lang="en">
  <head>
    <title>用户登录</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/login.css">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  </head>
  <body>
    <div id="root">
      <div class="login">
        <div class="content">
          <div class="main">
            <div class="header">
              <h2 class="title">用户登录</h2>
              <div class="register" @click="goRegister">用户注册</div>
            </div>
            <el-form ref="form" :rules="rules" :model="form" class="table">
              <el-form-item prop="username">
                <el-input v-model.trim="form.username" placeholder="请输入用户名"></el-input>
              </el-form-item>
              <el-form-item prop="password">
                <el-input v-model.trim="form.password" placeholder="请输入密码"></el-input>
              </el-form-item>
              <el-form-item prop="phone">
                <el-input v-model.trim="form.phone" placeholder="请输入手机号"></el-input>
              </el-form-item>
              <el-form-item prop="code">
                <el-input v-model.trim="form.code" style="width: 50%;" placeholder="请输入验证码"></el-input>
                <el-button type="primary" size="small" @click="getCode">{{ruleCode}}</el-button>
              </el-form-item>
              <el-form-item class="submit">
                <el-button type="primary" @click="onSubmit" style="width:100%">确定</el-button>
              </el-form-item>
            </el-form>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.12/vue.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script>
      new Vue({
        el: "#root",
        data () {
          return {
            form:{
              username: undefined,
              password: undefined,
              phone: undefined,
              code: undefined
            },
            ruleCode: "获取验证码",
            s: 60,
            iTimer: null,
            rules: {
              username: [
                { required: true, message: '用户名不能为空', trigger: 'blur' }
              ],
              password: [
                { required: true, message: '密码不能为空', trigger: 'blur' }
              ],
              phone: [
                { required: true, message: '手机号不能为空', trigger: 'blur' }
              ],
              code: [
                { required: true, message: '验证码不能为空', trigger: 'blur' }
              ]
            }
          }
        },
        created () {
          sessionStorage.clear()
        },
        methods: {
          onSubmit () {
            this.$refs["form"].validate(async valid => {
              if (valid) {
                axios.post("/api/login",this.form).then(res => {
                  if (res.data.code == 200) {
                    sessionStorage.setItem("token",res.data.data.token)
                    sessionStorage.setItem("position",res.data.data.position)
                    window.location.href = "/index.html"
                  } else {
                    this.$message.error(res.data.msg)
                  }
                })
              }
            })
          },
          goRegister () {
            window.location.href = "/register.html"
          },
          // 获取验证码
          getCode () {
            if (this.ruleCode != '获取验证码') {
              return true
            }
            if (!/^1[34578]\d{9}$/.test(this.form.phone)) {
              this.$message.error('手机号码格式不正确，且不能为空')
              return true
            }
            axios.post("/api/msgCode",{phone:this.form.phone}).then(res =>{
              if (res.data.code == 200) {
                this.$message({
                  message: '发送成功',
                  type: 'success'
                })
                this.iTimer = setInterval(() => {
                  if (this.s > 0) {
                    this.s--
                    this.ruleCode = this.s + 's'
                  } else {
                    clearInterval(this.iTimer)
                    this.ruleCode = '获取验证码'
                    this.s = 60
                  }
                }, 1000)
              }
            }).catch(err => {
              this.$message.error(res.data.msg)
            })
          },
        },
      })
    </script>
  </body>
</html>