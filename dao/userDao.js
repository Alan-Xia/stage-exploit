/**
 * 永久层
 */
import dbConfig from '../config/sql-server'
import request from '../controller/request'
import {successStatus,errorStatus} from '../plugins/status'
export function findLogin (username,password,req,res) {
  dbConfig(`SELECT position FROM t_user WHERE username='${username}' and password='${password}'`,[],(err,data) => {
    if (data) {
      successStatus.RESULT.data = {
        token: new Date().getTime(),
        position: data[0].position,
        username: data[0].username
      }
      req.session.userInfo = successStatus.RESULT.data
      res.status(200).json(successStatus.RESULT)
    } else {
      errorStatus.RESULT.msg = "用户名或密码错误"
      res.send(JSON.stringify(errorStatus.RESULT))
    }
    
  })
}

export function findRegistern (username,password,res) {
  // 连接数据库
  dbConfig("insert into t_user (id,username,password) values(null,?,?)",[username,password],(err,data) => {
    if (data != undefined) {
      successStatus.RESULT.data = {
        msg: "注册成功!"
      }
      res.status(200).json(successStatus.RESULT)
    } else {
      errorStatus.RESULT.msg = "用户名已存在，请重新注册"
      res.send(JSON.stringify(errorStatus.RESULT))
    }
  })
}

export function findUserList (res){
  request("SELECT id,username,position FROM t_user",[]).then(data => {
      if (data != undefined) {
        successStatus.RESULT.data = data
        res.status(200).json(successStatus.RESULT)
      } else {
        errorStatus.RESULT.msg = "获取列表失败"
        res.send(JSON.stringify(errorStatus.RESULT))
      }
  }).catch(err => {
    errorStatus.RESULT.msg = "获取列表失败"
    res.status(400).json(errorStatus.RESULT.msg)
  })
}